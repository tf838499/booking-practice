
# 演唱會售票系統模擬
## 概述
這個 side project 模擬了一個高需求的演唱會售票系統，  
展示如何使用 Golang、Redis 和 Postgres 處理大量同時請求的座位預訂和訂票提交。  
該專案旨在複製真實世界售票系統中的挑戰，重點在於效能、並發處理和資料一致性。

## 使用技術
### 後端
* Golang：核心程式語言，用於開發後端服務。  
* Postgres：關聯式資料庫，用於儲存票務和訂單資訊。  
* Redis：用於快取及處理高頻資料存取，特別是在管理座位預訂和可用性。  
### 資料庫操作
* sqlc：用於從 SQL 查詢生成型別安全的 Go 代碼，確保與 Postgres 的高效互動。  
* Migrations：資料庫 schema 管理和版本控制工具（例如 golang-migrate），確保 schema 的平滑演進。  
### 測試
* mockgen：用於生成模擬介面，實現元件的獨立單元測試。  
* dockertest：利用 Docker 容器進行外部依賴（如 Postgres 和 Redis）的測試，確保測試環境的一致性。  
* testify：強大的測試工具包，用於撰寫表達清晰的單元測試，包括斷言和測試套件。  
### 功能
* 高並發處理：系統設計用於處理大量並發請求，模擬真實情境下用戶搶購演唱會門票的場景。  
* 座位預訂邏輯：實現確保座位預訂在高負載下仍能一致且可靠的邏輯處理。  
* 訂票提交：在預訂後，系統處理訂單資訊，確保資料完整性並處理潛在的競爭條件。  

## 背景動機
在促銷活動、演唱會購票等特定時段，網站常常會瞬間湧入大量請求。為了學習這種情況，我選擇模擬演唱會搶票場景，
因為「選座」操作在大型場館中涉及大量數據，對後端性能要求極高。通過這個項目，我希望探索如何在可預見的高流量情況下，設計一個能夠支撐大規模選座操作的高效後端系統。


## 核心问题
老生常談的店商秒殺場景，例如某個品牌預告販售限量,一般情况下通常只會有幾種型號，這時候會偏向注重在商品的庫存，避免超賣或是沒有完售等等，
但對於演唱會售票來說，商品是一個個的座位號碼，在這種情況下，還要注意每個座位銷售的狀況，也就是說如果座位有一萬個就等同於一萬個不同的商品
1. 高效管理大量座位：每個座位都是獨立的「商品」，需要單獨管理，且會有大量座位資訊傳送
2. 避免重複銷售：確保每個座位在高並發環境下不會被多次售出，防止超賣。
3. 即時狀態更新：在高流量情況下，座位的銷售狀態必須即時更新，以維持數據的一致性和準確性。
4. 處理高並發請求：系統需能夠承受大量使用者同時搶購座位的壓力，並有效分配資源。

## 假設情境
1. 演唱會場次已知
2. 共10個廠區，1000個座位且座位號連續，總共10k個座位出售
3. 創建訂單後10秒內付款

## 期待目標
1. 一分鐘內銷售完所有座位
2. 座位不會超賣
3. 同時接受並處理10k的請求


## 流程設計

總共會主要會分成3隻API
- 取得演唱會座位資訊
- 創建購買訂單
- 接收付款資訊  

![](./docs/flow.PNG "flow overview")

###  取得演唱會座位資訊  

座位資訊包括座位號、價格、區域、座位販售狀態。根據測試，如果一次回傳所有區域的座位數據約為660KB，  
當有10,000個請求同時到來時，將消耗約6GB的流量。隨著座位數量和請求量的增加，頻寬和系統負荷將變得難以承受。  
此外，同時顯示大量座位對使用者來說不利於查看體驗。為了解決這些問題，我們將座位資訊拆分為兩個API：

1. 取得區域資訊：包括區域號、剩餘座位數、區域價格，數據量不到1KB。

2. 根據選擇區域查看剩餘座位：包括座位號、區域號、價格、座位狀態，數據量約為66.5KB。

透過拆分API，可以簡化數據傳輸，提升請求處理速度，並優化使用者的觀看體驗。  

![](./docs/Section.png "section flow overview")

### 創建購買訂單

訂單創建與座位鎖定
在創建訂單時，根據請求參數，主要包括座位號、客戶資訊和演唱會場次。在高併發情況下，可能會有多個請求同時選擇同一座位，若不加鎖，將導致超賣。鎖定機制的實施點至關重要，有兩種方案可考慮：

1. 請求進來時加鎖：一旦客戶點選座位，立即鎖定，避免其他請求選中同一座位。
2. 成功創建訂單後加鎖：在訂單要寫入資料庫時才進行鎖定。
考量到用戶體驗，若在最終創建訂單時才發現座位已被選走，將造成不佳體驗，因此選擇在請求一進來時就加鎖，以確保座位的獨占性。

在成功選取座位後，系統將生成訂單單號並發送到隊列中，等待客戶端付款。  

![](./docs/order.png "order flow overview")

### 接收付款資訊

通常在活動中，商品都會有設置付款期限，而有付款成功則消費訂單單號隊列，並更改訂單狀態為成功付款，而沒有接受到付款消息且超過預期時間則進入死信隊列，回復該訂單單號相關資料讓其他請求可以使用



## 專案結構 
/cmd：包含應用程式的入口點。  
/internal：核心應用程式邏輯，包括服務、模型和工具。  
/migrations：包含資料庫 schema 的遷移。  
/repo : 包含 sqlc 生成的代碼，包括查詢和模型。  
/testdata：包括模擬和基於 Docker 的測試資料。  
### 設置與安裝
1. 克隆專案
```bash=
git clone https://github.com/yourusername/concert-ticketing-system.git
cd concert-ticketing-system
```

2. 安裝依賴  
確保已安裝 Go、Docker 和 Postgres，然後安裝必要的 Go 套件：
```
go mod tidy  
```

3. 執行遷移  
應用資料庫遷移以設置 schema：
```
migrate -path ./migrations -database "postgres://user:password@localhost:5432/yourdb?sslmode=disable" up
```
4. 使用 sqlc 生成代碼  
生成與資料庫查詢對應的 Go 代碼：
```
sqlc generate
```
5. 運行應用程式  
啟動應用程式：
```
go run ./cmd/app/main.go
```

## 未來改進
擴展性：探索橫向擴展和負載平衡的選項。  
測試增強：擴大測試覆蓋範圍，引入更複雜的測試場景。  
用戶認證：新增用戶認證和授權層。  










